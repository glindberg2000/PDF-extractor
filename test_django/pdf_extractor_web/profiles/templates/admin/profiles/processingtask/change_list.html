{% extends "admin/change_list.html" %}
{% load i18n admin_urls static admin_list %}

{% block result_list %}
{% if cl.result_list %}
<div class="results">
    <table id="result_list">
        <thead>
            <tr>
                {% for header in cl.result_headers %}
                <th scope="col" {{ header.class_attrib }}>
                    {% if header.sortable %}
                    {% if header.sort_priority > 0 %}
                    <div class="sortoptions">
                        <a class="sortremove" href="{{ header.url_remove }}" title="{% translate " Remove from sorting"
                            %}"></a>
                        {% if num_sorted_fields > 1 %}<span class="sortpriority" title="{% translate " Sorting priority:
                            %(priority_number)s" %}">{{ header.sort_priority }}</span>{% endif %}
                        <a href="{{ header.url_toggle }}"
                            class="toggle {% if header.ascending %}ascending{% else %}descending{% endif %}"
                            title="{% translate " Toggle sorting" %}"></a>
                    </div>
                    {% endif %}
                    {% endif %}
                    <div class="text">{% if header.sortable %}<a href="{{ header.url_primary }}">{{ header.text|capfirst
                            }}</a>{% else %}<span>{{ header.text|capfirst }}</span>{% endif %}</div>
                    <div class="clear"></div>
                </th>{% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for result in cl.result_list %}
            {% if result.result_headers %}{% else %}
            <tr class="{% cycle 'row1' 'row2' %}">
                {% for item in result %}
                <td{{ item.class_attrib }}>
                    {% if item.field_name == "status" %}
                    {{ item.contents }}
                    {% if result.form.instance.status == "processing" %}
                    <div class="progress-bar"
                        style="background: #f0f0f0; border: 1px solid #ccc; height: 20px; width: 200px; margin-top: 5px;">
                        <div
                            style="background: #79aec8; height: 100%; width: {% widthratio result.form.instance.processed_count result.form.instance.transaction_count 100 %}%;">
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 2px;">
                        {{ result.form.instance.processed_count }} / {{ result.form.instance.transaction_count }}
                    </div>
                    {% endif %}
                    {% else %}
                    {{ item.contents }}
                    {% endif %}
                    </td>
                    {% endfor %}
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    .progress-bar {
        border-radius: 3px;
        overflow: hidden;
    }
</style>
<script>
    // Auto-refresh the page every 30 seconds if there are processing tasks
    {% if cl.result_list | dictsort: "status" | join: "" contains "processing" %}
    setTimeout(function () {
        window.location.reload();
    }, 30000);
    {% endif %}
</script>
{% endblock %}